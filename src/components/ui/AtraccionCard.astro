---
// src/components/ui/AtraccionCard.astro
interface Props {
    title: string;
    price: string;
    image: string;
    badge?: string;
    href: string;
}

const { title, price, image, badge, href } = Astro.props;
---

<article
    class="group relative bg-white overflow-hidden border-2 border-primary/30 hover:border-accent transition-all duration-300 hover:-translate-y-1 hover:shadow-xl hover:shadow-accent/20"
>
    <!-- Distintivo -->
    {
        badge && (
            <div class="absolute top-0 right-0 z-10 bg-accent text-white px-4 py-2 text-xs font-black uppercase tracking-wider rounded-bl-lg shadow-md border-b-2 border-l-2 border-amber-800">
                {badge}
            </div>
        )
    }

    <!-- Imagen -->
    <a
        href={href}
        class="block relative h-64 overflow-hidden border-b-4 border-accent group-hover:opacity-90 transition-opacity"
    >
        <img
            src={image}
            alt={title}
            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700 filter sepia-[0.3] group-hover:sepia-0"
        />
    </a>

    <!-- Contenido -->
    <div class="p-6 bg-bg-bone">
        <!-- Título -->
        <a href={href} class="block">
            <h3
                class="text-2xl font-display font-black mb-3 text-green-950 uppercase italic tracking-wide group-hover:text-accent transition-colors"
            >
                {title}
            </h3>
        </a>

        <!-- Información y Botón de acción (CTA) -->
        <div class="flex items-center justify-between mt-4">
            <div>
                <span class="text-lg font-black text-green-950">{price}</span>
            </div>

            <button
                data-id={title}
                data-title={title}
                data-price={price}
                class="add-to-cart-atraccion-btn w-10 h-10 bg-green-950 text-white flex items-center justify-center rounded hover:bg-accent transition-colors shadow-lg cursor-pointer border-none"
                aria-label="Añadir al carrito"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"
                    ></path>
                </svg>
            </button>
        </div>
    </div>
</article>

<script>
    import { addToCart } from "../../utils/cartStore";

    // Función auxiliar para parsear cadenas de precio como "Desde 50€" -> 50, "500€" -> 500
    function parsePrice(priceStr: string): number {
        const match = priceStr.match(/(\d+)/);
        return match ? parseInt(match[0], 10) : 0;
    }

    const buttons = document.querySelectorAll(".add-to-cart-atraccion-btn");
    buttons.forEach((btn) => {
        btn.addEventListener("click", (e) => {
            e.preventDefault(); // Prevenir propagación si está dentro de un enlace (aunque ahora es un botón)
            const target = e.currentTarget as HTMLButtonElement;
            const id = target.dataset.id;
            const title = target.dataset.title;
            const rawPrice = target.dataset.price || "0";
            const price = parsePrice(rawPrice);

            // Encontrar la imagen en la tarjeta (trepando hasta el article y luego buscando img)
            const article = target.closest("article");
            const img = article?.querySelector("img") as HTMLImageElement;
            const image = img ? img.src : "";

            addToCart({
                id,
                title,
                price,
                image,
            });

            // Feedback visual
            const originalHTML = target.innerHTML;
            // Icono de validación simple
            target.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            target.classList.add("!bg-green-600", "!text-white"); // forzar estilo específico

            setTimeout(() => {
                target.innerHTML = originalHTML;
                target.classList.remove("!bg-green-600", "!text-white");
            }, 1000);
        });
    });
</script>
